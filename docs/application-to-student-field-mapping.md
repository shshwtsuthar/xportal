# Application to Student Field Mapping - Complete Reference

## Overview

When an application is **approved** (status changes from `ACCEPTED` to `APPROVED`), the `approve-application` Edge Function copies all application data into normalized student-related tables. This document provides a complete field-by-field mapping of how each application field is transformed and stored in the student domain.

**Edge Function**: `supabase/functions/approve-application/index.ts`

**Trigger**: Application status changes from `ACCEPTED` → `APPROVED`

---

## Table of Contents

1. [Core Student Record](#1-core-student-record-publicstudents)
2. [Student Addresses](#2-student-addresses-publicstudent_addresses)
3. [AVETMISS Data](#3-avetmiss-data-publicstudent_avetmiss)
4. [Disabilities](#4-disabilities-publicstudent_disabilities)
5. [Prior Education](#5-prior-education-publicstudent_prior_education)
6. [CRICOS Data](#6-cricos-data-publicstudent_cricos)
7. [Emergency Contacts](#7-emergency-contacts-publicstudent_contacts_emergency)
8. [Guardian Contacts](#8-guardian-contacts-publicstudent_contacts_guardians)
9. [Enrollment](#9-enrollment-publicenrollments)
10. [Enrollment Subjects](#10-enrollment-subjects-publicenrollment_subjects)
11. [Enrollment Classes](#11-enrollment-classes-publicenrollment_classes)
12. [Invoices](#12-invoices-publicinvoices)
13. [Files/Documents](#13-filesdocuments-supabase-storage)
14. [Offer Letters](#14-offer-letters-publicoffer_letters)

---

## 1. Core Student Record (`public.students`)

**Direct field mappings from `applications` table:**

| Application Field | Student Field | Notes |
|------------------|--------------|-------|
| `rto_id` | `rto_id` | Tenant isolation |
| `id` | `application_id` | Foreign key to original application |
| `salutation` | `salutation` | Direct copy |
| `first_name` | `first_name` | **Required** - Non-null assertion used |
| `middle_name` | `middle_name` | Direct copy (nullable) |
| `last_name` | `last_name` | **Required** - Non-null assertion used |
| `preferred_name` | `preferred_name` | Direct copy (nullable) |
| `email` | `email` | **Required** - Non-null assertion used |
| `date_of_birth` | `date_of_birth` | **Required** - Non-null assertion used |
| `work_phone` | `work_phone` | Direct copy (nullable) |
| `mobile_phone` | `mobile_phone` | Direct copy (nullable) |
| `alternative_email` | `alternative_email` | Direct copy (nullable) |
| *(generated)* | `student_id_display` | Auto-generated by database trigger (format: `STU-{RTO}-{YY}-{NNNNN}-{C}`) |
| *(default)* | `status` | Set to `'ACTIVE'` |

**Code Reference**:
```typescript:129:145:supabase/functions/approve-application/index.ts
const studentInsert = {
  rto_id: app.rto_id,
  application_id: app.id,
  salutation: app.salutation,
  first_name: app.first_name!,
  middle_name: app.middle_name,
  last_name: app.last_name!,
  preferred_name: app.preferred_name,
  email: app.email!,
  date_of_birth: app.date_of_birth!,
  work_phone: app.work_phone,
  mobile_phone: app.mobile_phone,
  alternative_email: app.alternative_email,
  status: 'ACTIVE',
  // Pass empty string - trigger will generate the actual display ID
  student_id_display: '',
} as Db['public']['Tables']['students']['Insert'];
```

---

## 2. Student Addresses (`public.student_addresses`)

**Two address records created: Street Address (always) and Postal Address (conditional)**

### Street Address Record

| Application Field | Student Address Field | Notes |
|------------------|----------------------|-------|
| `student.id` | `student_id` | From newly created student |
| `rto_id` | `rto_id` | Tenant isolation |
| *(constant)* | `type` | Set to `'street'` |
| `street_building_name` | `building_name` | Direct copy (nullable) |
| `street_unit_details` | `unit_details` | Direct copy (nullable) |
| `street_number_name` | `number_name` | Direct copy (nullable) |
| `street_po_box` | `po_box` | Direct copy (nullable) |
| `suburb` | `suburb` | Direct copy |
| `state` | `state` | Direct copy |
| `postcode` | `postcode` | Direct copy |
| `street_country` | `country` | Direct copy (nullable) |
| *(constant)* | `is_primary` | Set to `true` |

### Postal Address Record

**Condition**: Only created if `postal_is_same_as_street === false`

| Application Field | Student Address Field | Notes |
|------------------|----------------------|-------|
| `student.id` | `student_id` | From newly created student |
| `rto_id` | `rto_id` | Tenant isolation |
| *(constant)* | `type` | Set to `'postal'` |
| `postal_building_name` | `building_name` | Direct copy (nullable) |
| `postal_unit_details` | `unit_details` | Direct copy (nullable) |
| `postal_number_name` | `number_name` | Direct copy (nullable) |
| `postal_po_box` | `po_box` | Direct copy (nullable) |
| `postal_suburb` | `suburb` | Direct copy (nullable) |
| `postal_state` | `state` | Direct copy (nullable) |
| `postal_postcode` | `postcode` | Direct copy (nullable) |
| `postal_country` | `country` | Direct copy (nullable) |
| *(constant)* | `is_primary` | Set to `false` |

**Code Reference**:
```typescript:364:412:supabase/functions/approve-application/index.ts
// 3b) Addresses (street + postal)
{
  const street = {
    student_id: student.id,
    rto_id: app.rto_id,
    type: 'street',
    building_name: app.street_building_name,
    unit_details: app.street_unit_details,
    number_name: app.street_number_name,
    po_box: app.street_po_box,
    suburb: app.suburb,
    state: app.state,
    postcode: app.postcode,
    country: app.street_country,
    is_primary: true,
  } as const;
  const postal = app.postal_is_same_as_street
    ? null
    : {
        student_id: student.id,
        rto_id: app.rto_id,
        type: 'postal',
        building_name: app.postal_building_name,
        unit_details: app.postal_unit_details,
        number_name: app.postal_number_name,
        po_box: app.postal_po_box,
        suburb: app.postal_suburb,
        state: app.postal_state,
        postcode: app.postal_postcode,
        country: app.postal_country,
        is_primary: false,
      };
  const addrRows = [street, postal].filter(
    Boolean
  ) as Db['public']['Tables']['student_addresses']['Insert'][];
  if (addrRows.length > 0) {
    const { error: addrErr } = await supabase
      .from('student_addresses')
      .insert(addrRows);
    // ... error handling
  }
}
```

---

## 3. AVETMISS Data (`public.student_avetmiss`)

**Single record created per student with all AVETMISS compliance fields**

| Application Field | Student AVETMISS Field | Notes |
|------------------|----------------------|-------|
| `student.id` | `student_id` | From newly created student |
| `rto_id` | `rto_id` | Tenant isolation |
| `gender` | `gender` | NAT00080: Client Gender (M/F/X/@) |
| `highest_school_level_id` | `highest_school_level_id` | NAT00080: Highest School Level Completed |
| `year_highest_school_level_completed` | `year_highest_school_level_completed` | NAT00080: Year completed (2-digit or @@ or @@@@) |
| `indigenous_status_id` | `indigenous_status_id` | NAT00080: Indigenous Status (1-9) |
| `labour_force_status_id` | `labour_force_status_id` | NAT00080: Labour Force Status (01-06) |
| `country_of_birth_id` | `country_of_birth_id` | NAT00080: Country of Birth |
| `language_code` | `language_code` | NAT00080: Language Identifier |
| `citizenship_status_code` | `citizenship_status_code` | NAT00080: Client Citizenship Status |
| `at_school_flag` | `at_school_flag` | NAT00080: At School Flag (Y/N) |
| `disability_flag` | `disability_flag` | NAT00080: Disability Flag (Y/N/@) - Defaults to null if not set |
| `prior_education_flag` | `prior_education_flag` | NAT00085: Prior Education Flag (Y/N/@) - Defaults to null if not set |
| `survey_contact_status` | `survey_contact_status` | NAT00080: Survey Contact Status - Defaults to 'A' if not set |
| `vsn` | `vsn` | NAT00080: Victorian Student Number (9 digits or 000000000) - Defaults to null |
| `usi` | `usi` | NAT00080: Unique Student Identifier (10 chars) - Defaults to null |

**Code Reference**:
```typescript:414:444:supabase/functions/approve-application/index.ts
// 3c) AVETMISS snapshot
{
  const { error: avErr } = await supabase.from('student_avetmiss').insert({
    student_id: student.id,
    rto_id: app.rto_id,
    gender: app.gender,
    highest_school_level_id: app.highest_school_level_id,
    year_highest_school_level_completed:
      app.year_highest_school_level_completed,
    indigenous_status_id: app.indigenous_status_id,
    labour_force_status_id: app.labour_force_status_id,
    country_of_birth_id: app.country_of_birth_id,
    language_code: app.language_code,
    citizenship_status_code: app.citizenship_status_code,
    at_school_flag: app.at_school_flag,
    disability_flag: app.disability_flag || null,
    prior_education_flag: app.prior_education_flag || null,
    survey_contact_status: app.survey_contact_status || 'A',
    vsn: app.vsn || null,
    usi: app.usi || null,
  });
  // ... error handling
}
```

---

## 4. Disabilities (`public.student_disabilities`)

**Multiple records created (one per disability type)**

**Source**: `application_disabilities` junction table

**Process**:
1. Fetch all disabilities from `application_disabilities` where `application_id = app.id`
2. For each disability, create a record in `student_disabilities`

| Application Disability Field | Student Disability Field | Notes |
|-----------------------------|-------------------------|-------|
| `student.id` | `student_id` | From newly created student |
| `rto_id` | `rto_id` | Tenant isolation |
| `disability_type_id` | `disability_type_id` | Direct copy (AVETMISS codes: 11-19) |

**Code Reference**:
```typescript:446:484:supabase/functions/approve-application/index.ts
// 3c1) Copy disabilities from application to student
{
  const { data: appDisabilities, error: fetchErr } = await supabase
    .from('application_disabilities')
    .select('disability_type_id')
    .eq('application_id', app.id);

  if (fetchErr) {
    // ... error handling
  }

  if (appDisabilities && appDisabilities.length > 0) {
    const studentDisabilities = appDisabilities.map((d) => ({
      student_id: student.id,
      rto_id: app.rto_id,
      disability_type_id: d.disability_type_id,
    }));

    const { error: disErr } = await supabase
      .from('student_disabilities')
      .insert(studentDisabilities);
    // ... error handling
  }
}
```

---

## 5. Prior Education (`public.student_prior_education`)

**Multiple records created (one per qualification with recognition type)**

**Source**: `application_prior_education` junction table

**Process**:
1. Fetch all prior education from `application_prior_education` where `application_id = app.id`
2. For each prior education record, create a record in `student_prior_education`

| Application Prior Education Field | Student Prior Education Field | Notes |
|----------------------------------|------------------------------|-------|
| `student.id` | `student_id` | From newly created student |
| `rto_id` | `rto_id` | Tenant isolation |
| `prior_achievement_id` | `prior_achievement_id` | Direct copy (AVETMISS codes: 008, 410, 420, 511, 514, 521, 524, 990) |
| `recognition_type` | `recognition_type` | Direct copy (A/E/I) - Defaults to null if not set |

**Code Reference**:
```typescript:486:527:supabase/functions/approve-application/index.ts
// 3c2) Copy prior education from application to student
{
  const { data: appPriorEd, error: fetchErr } = await supabase
    .from('application_prior_education')
    .select('prior_achievement_id, recognition_type')
    .eq('application_id', app.id);

  if (fetchErr) {
    // ... error handling
  }

  if (appPriorEd && appPriorEd.length > 0) {
    const studentPriorEd = appPriorEd.map((e) => ({
      student_id: student.id,
      rto_id: app.rto_id,
      prior_achievement_id: e.prior_achievement_id,
      recognition_type: e.recognition_type || null,
    }));

    const { error: priorEdErr } = await supabase
      .from('student_prior_education')
      .insert(studentPriorEd);
    // ... error handling
  }
}
```

---

## 6. CRICOS Data (`public.student_cricos`)

**Single record created per student (only if international student)**

| Application Field | Student CRICOS Field | Notes |
|------------------|---------------------|-------|
| `student.id` | `student_id` | From newly created student |
| `rto_id` | `rto_id` | Tenant isolation |
| `is_international` | `is_international` | Boolean - Converted using `Boolean()` |
| `passport_number` | `passport_number` | Direct copy (nullable) |
| `passport_issue_date` | `passport_issue_date` | Direct copy (nullable) |
| `passport_expiry_date` | `passport_expiry_date` | Direct copy (nullable) |
| `place_of_birth` | `place_of_birth` | Direct copy (nullable) |
| `visa_type` | `visa_type` | Direct copy (nullable) |
| `visa_number` | `visa_number` | Direct copy (nullable) |
| `visa_application_office` | `visa_application_office` | Direct copy (nullable) |
| `country_of_citizenship` | `country_of_citizenship` | Direct copy (nullable) |
| `is_under_18` | `is_under_18` | Direct copy (nullable boolean) |
| `provider_accepting_welfare_responsibility` | `provider_accepting_welfare_responsibility` | Direct copy (nullable boolean) |
| `welfare_start_date` | `welfare_start_date` | Direct copy (nullable) |
| `provider_arranged_oshc` | `provider_arranged_oshc` | Direct copy (nullable boolean) |
| `oshc_provider_name` | `oshc_provider_name` | Direct copy (nullable) |
| `oshc_start_date` | `oshc_start_date` | Direct copy (nullable) |
| `oshc_end_date` | `oshc_end_date` | Direct copy (nullable) |
| `has_english_test` | `has_english_test` | Direct copy (nullable boolean) |
| `english_test_type` | `english_test_type` | Direct copy (nullable) |
| `english_test_date` | `english_test_date` | Direct copy (nullable) |
| `ielts_score` | `ielts_score` | Direct copy (nullable) |
| `has_previous_study_australia` | `has_previous_study_australia` | Direct copy (nullable boolean) |
| `previous_provider_name` | `previous_provider_name` | Direct copy (nullable) |
| `completed_previous_course` | `completed_previous_course` | Direct copy (nullable boolean) |
| `has_release_letter` | `has_release_letter` | Direct copy (nullable boolean) |

**Code Reference**:
```typescript:529:569:supabase/functions/approve-application/index.ts
// 3d) CRICOS snapshot
{
  const { error: crErr } = await supabase.from('student_cricos').insert({
    student_id: student.id,
    rto_id: app.rto_id,
    is_international: Boolean(app.is_international),
    passport_number: app.passport_number,
    passport_issue_date: app.passport_issue_date,
    passport_expiry_date: app.passport_expiry_date,
    place_of_birth: app.place_of_birth,
    visa_type: app.visa_type,
    visa_number: app.visa_number,
    visa_application_office: app.visa_application_office,
    country_of_citizenship: app.country_of_citizenship,
    is_under_18: app.is_under_18,
    provider_accepting_welfare_responsibility:
      app.provider_accepting_welfare_responsibility,
    welfare_start_date: app.welfare_start_date,
    provider_arranged_oshc: app.provider_arranged_oshc,
    oshc_provider_name: app.oshc_provider_name,
    oshc_start_date: app.oshc_start_date,
    oshc_end_date: app.oshc_end_date,
    has_english_test: app.has_english_test,
    english_test_type: app.english_test_type,
    english_test_date: app.english_test_date,
    ielts_score: app.ielts_score,
    has_previous_study_australia: app.has_previous_study_australia,
    previous_provider_name: app.previous_provider_name,
    completed_previous_course: app.completed_previous_course,
    has_release_letter: app.has_release_letter,
  });
  // ... error handling
}
```

---

## 7. Emergency Contacts (`public.student_contacts_emergency`)

**Single record created (only if at least one field is present)**

**Condition**: Record created if `ec_name || ec_phone_number || ec_relationship` is truthy

| Application Field | Student Emergency Contact Field | Notes |
|------------------|-------------------------------|-------|
| `student.id` | `student_id` | From newly created student |
| `rto_id` | `rto_id` | Tenant isolation |
| `ec_name` | `name` | Direct copy (nullable) |
| `ec_relationship` | `relationship` | Direct copy (nullable) |
| `ec_phone_number` | `phone_number` | Direct copy (nullable) |

**Code Reference**:
```typescript:571:598:supabase/functions/approve-application/index.ts
// 3e) Emergency and guardian contacts
{
  const inserts: Db['public']['Tables']['student_contacts_emergency']['Insert'][] =
    [];
  if (app.ec_name || app.ec_phone_number || app.ec_relationship) {
    inserts.push({
      student_id: student.id,
      rto_id: app.rto_id,
      name: app.ec_name,
      relationship: app.ec_relationship,
      phone_number: app.ec_phone_number,
    });
  }
  if (inserts.length > 0) {
    const { error: ecErr } = await supabase
      .from('student_contacts_emergency')
      .insert(inserts);
    // ... error handling
  }
}
```

---

## 8. Guardian Contacts (`public.student_contacts_guardians`)

**Single record created (only if at least one field is present)**

**Condition**: Record created if `g_name || g_email || g_phone_number` is truthy

| Application Field | Student Guardian Contact Field | Notes |
|------------------|------------------------------|-------|
| `student.id` | `student_id` | From newly created student |
| `rto_id` | `rto_id` | Tenant isolation |
| `g_name` | `name` | Direct copy (nullable) |
| `g_email` | `email` | Direct copy (nullable) |
| `g_phone_number` | `phone_number` | Direct copy (nullable) |
| `g_relationship` | `relationship` | Direct copy (nullable) |

**Code Reference**:
```typescript:598:619:supabase/functions/approve-application/index.ts
if (app.g_name || app.g_email || app.g_phone_number) {
  const { error: gErr } = await supabase
    .from('student_contacts_guardians')
    .insert({
      student_id: student.id,
      rto_id: app.rto_id,
      name: app.g_name,
      email: app.g_email,
      phone_number: app.g_phone_number,
      relationship: app.g_relationship,
    });
  // ... error handling
}
```

---

## 9. Enrollment (`public.enrollments`)

**Single enrollment record created per student**

| Application Field | Enrollment Field | Notes |
|------------------|-----------------|-------|
| `student.id` | `student_id` | From newly created student |
| `program_id` | `program_id` | Direct copy |
| `rto_id` | `rto_id` | Tenant isolation |
| *(constant)* | `status` | Set to `'ACTIVE'` |
| `anchorDate` (computed) | `commencement_date` | See anchor date precedence below |
| `payment_plan_template_id` | `payment_plan_template_id` | Direct copy |

**Anchor Date Precedence** (used for `commencement_date`):
1. `app.payment_anchor_date` (if set)
2. `app.proposed_commencement_date` (if set)
3. `app.offer_generated_at` (if set, converted to date)

**Code Reference**:
```typescript:261:282:supabase/functions/approve-application/index.ts
// 2) Create enrollment and copy template id
const { data: enrollment, error: enrErr } = await supabase
  .from('enrollments')
  .insert({
    student_id: student.id,
    program_id: app.program_id, // align with current schema
    rto_id: app.rto_id,
    status: 'ACTIVE',
    commencement_date: anchorDate,
    payment_plan_template_id: app.payment_plan_template_id,
  })
  .select('*')
  .single();
```

---

## 10. Enrollment Subjects (`public.enrollment_subjects`)

**Multiple records created (one per subject in learning plan)**

**Source**: `application_learning_subjects` snapshot table

**Process**:
1. Fetch all subjects from `application_learning_subjects` where `application_id = app.id`
2. Order by `sequence_order` ascending
3. For each subject, create an enrollment subject record

| Application Learning Subject Field | Enrollment Subject Field | Notes |
|------------------------------------|-------------------------|-------|
| `enrollment.id` | `enrollment_id` | From newly created enrollment |
| `program_plan_subject_id` | `program_plan_subject_id` | Direct copy |
| *(null)* | `outcome_code` | Set to `null` (will be updated during course progression) |
| `planned_start_date` | `start_date` | Direct copy |
| `planned_end_date` | `end_date` | Direct copy |
| `is_catch_up` | `is_catch_up` | Direct copy (boolean) |
| *(null)* | `delivery_location_id` | Set to `null` |
| *(null)* | `delivery_mode_id` | Set to `null` |
| *(null)* | `scheduled_hours` | Set to `null` |

**Code Reference**:
```typescript:621:659:supabase/functions/approve-application/index.ts
// 3f) Learning plan subjects → enrollment_subjects
{
  const { data: subjects, error: subjErr } = await supabase
    .from('application_learning_subjects')
    .select(
      'program_plan_subject_id, subject_id, planned_start_date, planned_end_date, is_catch_up, is_prerequisite'
    )
    .eq('application_id', app.id)
    .order('sequence_order', { ascending: true });
  if (!subjErr && subjects && subjects.length > 0) {
    const rows = subjects.map(
      (
        s: Db['public']['Tables']['application_learning_subjects']['Row']
      ) => ({
        enrollment_id: enrollment.id,
        program_plan_subject_id: s.program_plan_subject_id,
        outcome_code: null,
        start_date: s.planned_start_date,
        end_date: s.planned_end_date,
        is_catch_up: s.is_catch_up,
        delivery_location_id: null,
        delivery_mode_id: null,
        scheduled_hours: null,
      })
    );
    const { error: insErr } = await supabase
      .from('enrollment_subjects')
      .insert(rows);
    // ... error handling
  }
}
```

---

## 11. Enrollment Classes (`public.enrollment_classes`)

**Multiple records created (one per class in learning plan)**

**Source**: `application_learning_classes` snapshot table

**Process**:
1. Fetch all classes from `application_learning_classes` where `application_id = app.id`
2. For each class, create an enrollment class record

| Application Learning Class Field | Enrollment Class Field | Notes |
|---------------------------------|----------------------|-------|
| `enrollment.id` | `enrollment_id` | From newly created enrollment |
| `program_plan_class_id` | `program_plan_class_id` | Direct copy |
| `class_date` | `class_date` | Direct copy |
| `start_time` | `start_time` | Direct copy |
| `end_time` | `end_time` | Direct copy |
| `trainer_id` | `trainer_id` | Direct copy (nullable) |
| `location_id` | `location_id` | Direct copy (nullable) |
| `classroom_id` | `classroom_id` | Direct copy (nullable) |
| `class_type` | `class_type` | Direct copy (nullable) |
| *(null)* | `notes` | Set to `null` |

**Code Reference**:
```typescript:661:699:supabase/functions/approve-application/index.ts
// 3g) Learning plan classes → enrollment_classes
{
  const { data: classes, error: clsErr } = await supabase
    .from('application_learning_classes')
    .select(
      'program_plan_class_id, class_date, start_time, end_time, trainer_id, location_id, classroom_id, class_type'
    )
    .eq('application_id', app.id);
  if (!clsErr && classes && classes.length > 0) {
    const rows = classes.map(
      (
        c: Db['public']['Tables']['application_learning_classes']['Row']
      ) => ({
        enrollment_id: enrollment.id,
        program_plan_class_id: c.program_plan_class_id,
        class_date: c.class_date,
        start_time: c.start_time,
        end_time: c.end_time,
        trainer_id: c.trainer_id,
        location_id: c.location_id,
        classroom_id: c.classroom_id,
        class_type: c.class_type,
        notes: null,
      })
    );
    const { error: insErr } = await supabase
      .from('enrollment_classes')
      .insert(rows);
    // ... error handling
  }
}
```

---

## 12. Invoices (`public.invoices`)

**Multiple records created (one per payment installment)**

**Source**: `application_payment_schedule` snapshot (preferred) OR computed from `payment_plan_template_installments`

### Option A: From Payment Schedule Snapshot

**Process**:
1. Fetch all installments from `application_payment_schedule` where `application_id = app.id`
2. Order by `sequence_order`, `due_date`, `name` (all ascending)
3. For each installment, create an invoice

| Payment Schedule Field | Invoice Field | Notes |
|----------------------|--------------|-------|
| `enrollment.id` | `enrollment_id` | From newly created enrollment |
| `rto_id` | `rto_id` | Tenant isolation |
| *(computed)* | `status` | `'SENT'` for first invoice, `'SCHEDULED'` for others |
| *(generated)* | `invoice_number` | Generated using `crypto.randomUUID()` |
| *(computed)* | `issue_date` | Current date for first invoice, `due_date` for others |
| `due_date` | `due_date` | Direct copy |
| `amount_cents` | `amount_due_cents` | Direct copy |
| *(constant)* | `amount_paid_cents` | Set to `0` |

### Option B: Computed from Template (Fallback)

**Process**:
1. Fetch installments from `payment_plan_template_installments` where `template_id = app.payment_plan_template_id`
2. Order by `due_date_rule_days` ascending
3. Calculate due dates: `anchorDate + due_date_rule_days`
4. Create invoices with calculated dates

| Template Installment Field | Invoice Field | Notes |
|---------------------------|--------------|-------|
| `enrollment.id` | `enrollment_id` | From newly created enrollment |
| `rto_id` | `rto_id` | Tenant isolation |
| *(computed)* | `status` | `'SENT'` for first invoice, `'SCHEDULED'` for others |
| *(generated)* | `invoice_number` | Generated using `crypto.randomUUID()` |
| *(computed)* | `issue_date` | Current date for first invoice, calculated due date for others |
| *(computed)* | `due_date` | `anchorDate + due_date_rule_days` |
| `amount_cents` | `amount_due_cents` | Direct copy |
| *(constant)* | `amount_paid_cents` | Set to `0` |

**Code Reference**:
```typescript:284:360:supabase/functions/approve-application/index.ts
// 3) Use application_payment_schedule snapshot if present; fallback to on-the-fly calc
const { data: snapshot, error: snapErr } = await supabase
  .from('application_payment_schedule')
  .select('name, amount_cents, due_date')
  .eq('application_id', app.id)
  .order('sequence_order', { ascending: true })
  .order('due_date', { ascending: true })
  .order('name', { ascending: true });

let invoiceRows: Db['public']['Tables']['invoices']['Insert'][] = [];
if (!snapErr && snapshot && snapshot.length > 0) {
  // Use snapshot
  invoiceRows = snapshot.map((row, idx) => {
    const isFirst = idx === 0;
    return {
      enrollment_id: enrollment.id,
      rto_id: app.rto_id,
      status: isFirst ? 'SENT' : 'SCHEDULED',
      invoice_number: crypto.randomUUID(),
      issue_date: isFirst
        ? new Date().toISOString().slice(0, 10)
        : (row.due_date as string),
      due_date: row.due_date as string,
      amount_due_cents: row.amount_cents as number,
      amount_paid_cents: 0,
    } as Db['public']['Tables']['invoices']['Insert'];
  });
} else {
  // Fallback: compute from template
  const { data: installments, error: instErr } = await supabase
    .from('payment_plan_template_installments')
    .select('id, name, amount_cents, due_date_rule_days')
    .eq('template_id', template.id)
    .order('due_date_rule_days', { ascending: true });
  // ... compute invoices
}
```

---

## 13. Files/Documents (Supabase Storage)

**Files copied from application storage to student storage**

**Source Bucket**: `applications`
**Source Path**: `applications/{applicationId}/**`

**Target Bucket**: `students`
**Target Path**: `students/{studentId}/**`

**Process**:
1. Recursively list all files in `applications/{applicationId}/`
2. For each file:
   - Download from `applications` bucket
   - Upload to `students` bucket at `students/{studentId}/{relativePath}`
   - Preserve content type
   - Preserve file structure (subdirectories)

**Note**: File copy failures are logged as warnings but do not block approval

**Code Reference**:
```typescript:166:259:supabase/functions/approve-application/index.ts
// 1b) Copy files from applications bucket to students bucket
const fileCopyWarnings: string[] = [];
try {
  // Recursively list all files
  const applicationFiles = await listFilesRecursively(
    'applications',
    app.id
  );

  // Copy each file to students bucket
  for (const filePath of applicationFiles) {
    // Download from applications bucket
    const { data: fileData } = await service.storage
      .from('applications')
      .download(filePath);

    // Calculate relative path (remove applicationId prefix)
    const relativePath = filePath.startsWith(`${app.id}/`)
      ? filePath.slice(`${app.id}/`.length)
      : filePath;

    // Upload to students bucket
    const targetPath = `${student.id}/${relativePath}`;
    await service.storage
      .from('students')
      .upload(targetPath, fileData, {
        contentType: contentType,
        upsert: false,
      });
  }
} catch (copyErr) {
  // Log but don't fail approval
  fileCopyWarnings.push(/* error message */);
}
```

---

## 14. Offer Letters (`public.offer_letters`)

**Link existing offer letters to student record**

**Process**:
1. Update all `offer_letters` records where `application_id = app.id` AND `student_id IS NULL`
2. Set `student_id = student.id`

**Note**: This links offer letters that were generated during the application process to the newly created student record

**Code Reference**:
```typescript:701:715:supabase/functions/approve-application/index.ts
// 3h) Update offer_letters to link to student
{
  const { error: offerErr } = await service
    .from('offer_letters')
    .update({ student_id: student.id })
    .eq('application_id', app.id)
    .is('student_id', null);
  if (offerErr) {
    // Log but don't fail approval
    console.error('Failed to link offer letters to student:', offerErr);
    fileCopyWarnings.push(
      `Failed to link offer letters: ${offerErr.message}`
    );
  }
}
```

---

## Summary: Complete Field Mapping

### Fields NOT Mapped to Student Tables

The following application fields are **not** copied to student tables (they remain only in the application record):

- `id` (application ID - stored as `application_id` FK in students table)
- `created_at`, `updated_at` (application timestamps)
- `status` (application status - separate from student status)
- `assigned_to` (application assignment)
- `agent_id` (agent relationship - not copied to student)
- `timetable_id` (used to generate learning plan, not stored on student)
- `address_line_1` (legacy field - replaced by structured address)
- `offer_generated_at` (used for anchor date calculation only)
- `usi_exemption_code` (not stored on student - exemption is historical)

### Execution Order

The approval process executes in this order:

1. **Create student record** (`public.students`)
2. **Copy files** (Supabase Storage)
3. **Create enrollment** (`public.enrollments`)
4. **Create invoices** (`public.invoices`)
5. **Create addresses** (`public.student_addresses`)
6. **Create AVETMISS record** (`public.student_avetmiss`)
7. **Copy disabilities** (`public.student_disabilities`)
8. **Copy prior education** (`public.student_prior_education`)
9. **Create CRICOS record** (`public.student_cricos`)
10. **Create emergency contact** (`public.student_contacts_emergency`)
11. **Create guardian contact** (`public.student_contacts_guardians`)
12. **Create enrollment subjects** (`public.enrollment_subjects`)
13. **Create enrollment classes** (`public.enrollment_classes`)
14. **Link offer letters** (`public.offer_letters`)
15. **Update application status** to `APPROVED`
16. **Sync to Xero** (asynchronous, non-blocking)

### Error Handling

- If any step fails, the entire approval is rolled back (transaction-like behavior via sequential operations)
- File copy failures are logged as warnings but do not block approval
- Xero sync failures are logged but do not block approval

### Data Integrity

- All student records maintain `rto_id` for tenant isolation
- All records maintain `student_id` foreign key to core student record
- Application ID preserved via `application_id` FK in students table
- Learning plan and payment schedule snapshots ensure data consistency

---

## Related Documentation

- [Student Data Structure](./student-data-structure.md) - Overview of normalized student tables
- [New Application Wizard Guide](./new-application-wizard-complete-guide.md) - Complete wizard documentation
- [Application Schema](../src/lib/applicationSchema.ts) - Validation schema with all fields

